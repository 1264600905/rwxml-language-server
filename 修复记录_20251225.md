# RimWorld XML 分析器复活与修复记录 (2025-12-25)

## 1. 当前总体状态
*   **核心库 (Analyzer)**: 已完成现代化重构。脱离了过时的 `cheerio` 依赖，改用高性能原生 DOM 解析。支持 1.6 版本元数据。
*   **插件端 (VSC Extension)**: 已实现本地 1.6 元数据直载，解决了大文件 (92MB) 编码识别问题（支持 UTF-16 LE）。
*   **逻辑端 (Language Server)**: 修复了初始化崩溃 Bug，实现了递归式“严格校验”模式。

## 2. 已解决的“红字” (误报) 问题

### A. 字典与列表简写语法 (Shorthand Syntax)
*   **现象**: 官方文件中的技能 (`skillGains`)、特性 (`forcedTraits`)、携带物 (`possessions`) 报错 `Undefined property`。
*   **原因**: RimWorld 允许直接将数据（如 `Melee`, `Brawler`）作为标签名，而分析器原本只寻找 C# 类中的字段。
*   **修复**: 改进了 `TypeInfoInjector`，如果发现列表内出现了非 `<li>` 标签，会自动尝试将其识别为元素类型或字典键值对。

### B. Nullable 类型解包 (Nullable Unwrapping)
*   **现象**: Anomaly DLC 中的绘图属性（如 `rotationOffset`, `flip`, `layer`）报错 `Undefined property`。
*   **原因**: 这些字段在 C# 中被包裹在 `Nullable<T>` 容器里，分析器此前无法看到容器内部的字段。
*   **修复**: 在 `TypeInfo` 中增加了 `isNullable()` 判定和自动拆包逻辑，现在分析器能穿透容器直接校验内部字段。

### C. 缺失官方 DLC 数据
*   **现象**: 引用官方 DLC 内容时报错 `Unresolved reference`。
*   **原因**: 插件默认只加载了 Core 数据，没去读 DLC 的 XML。
*   **修复**: 在 `modDependencyBags.ts` 中强制补全了 **Biotech, Anomaly, Odyssey** 等所有 DLC 的自动加载路径。

## 3. 后续修复红字的排查思路

如果你在后续体验中发现还有不该出现的红线，请按以下顺序排查：

### 情况 1：依然显示 `Undefined property` (不认识标签)
*   **可能原因**: 又是某种新的简写语法，或者是嵌套层级非常深的泛型。
*   **排查**: 在 `精选日志.log` 中查找该标签对应的父节点类型（ClassName）。
*   **修复方向**: 修改 `analyzer/src/rimworld-types/typeInfoInjector.ts`，增加对应的特殊处理逻辑。

### 情况 2：显示 `Unresolved reference` (找不到引用)
*   **可能原因**: 
    1. 缺少依赖模组：如果你的模组引用了其他三方模组的东西，需要在插件设置或 `About.xml` 中配置。
    2. 目标 Def 确实不存在：检查拼写。
*   **验证**: 确认目标 XML 是否被扫描到（在插件“输出”面板中查看 `found X dependency files` 日志）。

### 情况 3：满屏红线或没有任何反应
*   **排查**: 查看“输出”面板中的 `RWXML Language Server` 分类。
*   **常见报错**: `uncaughtException: TypeError: ... is not a function`。
*   **修复方向**: 这通常意味着元数据 JSON 里有脏数据，导致 `TypeInfo` 对象的方法丢失。需在 `analyzer/src/rimworld-types/typeInfo.ts` 中加入安全检查（类似我们之前加的 `typeof ... === 'function'`）。

## 4. 调试与构建命令
*   **构建全项目**: `cd analyzer; npx tsc -b; cd ../language-server; npm run build; cd ../vsc-extension; npm run build`
*   **本地测试脚本**: `cd analyzer; npx ts-node src/run-test.ts` (可直接修改脚本内的路径进行快速验证)

---
**加油！目前的工具链已经非常健壮，剩下的红字基本上都是具体的业务逻辑适配了。**
